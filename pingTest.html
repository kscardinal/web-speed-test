<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sonnaz Group | Speedtest</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="body-container">
        <h2 id="ping-box-title">Speed Test</h2>
        <p id="ping-text"></p>
        <p id="ping-average-text"></p>
        <button id="ping-test-button">Test Ping</button>
    </div>
</body>
<script>
    // Supported Website
    const host = 'https://api.github.com'; 

    function getGradientColor(percent) {
        let r, g, b = 0;

        if (percent <= 50) {
            // Red to Yellow-ish
            r = 255;
            g = Math.round(220 * (percent / 50));  // max green 220 instead of 255
        } else {
            // Yellow-ish to Darker Green
            g = 180 + Math.round(40 * ((100 - percent) / 50)); // g goes 220->180
            r = Math.round(255 * ((100 - percent) / 50));       // r goes 255->0
        }

        return `rgb(${r},${g},${b})`;
    }

    async function pingHost(host, count = 1) {
        let total = 0;
        for (let i = 0; i < count; i++) {
            const start = performance.now();
            await fetch(host, { method: 'HEAD', cache: 'no-cache' });
            const end = performance.now();
            const time = end - start;
            // console.log(`Ping ${i + 1}: ${time.toFixed(2)} ms`);
            total += time;
        }
        const avg = total / count;
        return avg;
    }


    const pingText = document.getElementById('ping-text');
    const pingButton = document.getElementById('ping-test-button');
    const pingAverageText = document.getElementById('ping-average-text')

    // TODO: Make button switch to cancel while it is going and if you press it, it stop the ping test
    pingButton.addEventListener('click', async () => {
        
        // Diable button while testing
        pingButton.disabled = true;

        // Setup
        const pingTimes = [];
        const pingInterval = 100; // ms (0.1 seconds)
        const pingDuration = 10000; // ms (10 seconds)
        const startTime = performance.now(); // Start time

        while (performance.now() -startTime < pingDuration) {
            pingAverageText.textContent = "ms"
            try {
                const pingTime = await pingHost(host);
                pingTimes.push(pingTime);

                pingText.textContent = `${pingTime.toFixed(0)}`;
                pingText.style.color = getGradientColor(100 - pingTime + 15)
            } catch (err) {
                console.error('Ping failed:', err);
            }
            await new Promise(resolve => setTimeout(resolve, pingInterval));
        }
        // Enable button 
        pingButton.disabled = false;

        // Set label to average
        const pingAverage = pingTimes.reduce((a,b) => a+b, 0) / pingTimes.length;
        pingText.textContent = `${pingAverage.toFixed(0)}`;
        pingText.style.color = getGradientColor(100 - pingAverage + 15)
        pingAverageText.textContent = "avg"
    });

    

</script>
</html>