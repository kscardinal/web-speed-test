<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sonnaz Group | Speedtest</title>
  <link rel="stylesheet" href="../css/style_download.css">
</head>
<body>
    <div class="body-container">
        <h2 id="test-box-title">Download</h2>
        
        <svg width="300" height="300" viewBox="0 0 200 200" id="downloadSVG" class="download">
            <circle id="downloadBackground" cx="100" cy="100" r="67.5"/>
            <circle id="downloadProgress" cx="100" cy="100" r="67.5"/>
            <text x="100" y="100" id="test-text"></text>
            <text x="100" y="125" id="test-unit-text">Mbps</text>
            <text x="100" y="70" id="test-average-text"></text>
            <text x="25" y="150" class="min-max-label">0</text>
            <text x="177" y="150" class="min-max-label" id="max-label"></text>
        </svg>

        <button id="download-test-button" class="testButton">Test Download</button>
        <button id="scale-button" class="updateButton">Change scale</button>
    </div>
</body>
<script>

    // Download Files
    const fileSize_10MB = 'http://162.243.22.90/10MB.bin';
    const fileSize_100MB = 'http://162.243.22.90/100MB.bin';
    const fileSize_250MB = 'http://162.243.22.90/250MB.bin';
    const fileSize_500MB = 'http://162.243.22.90/500MB.bin';
    const fileSize_1GB = 'http://162.243.22.90/1GB.bin';

    let topSpeed = 500;
    let averageSpeed = 0;
    let speed = 0;


    function getGradientColor(percent) {
        let r, g, b = 0;

        if (percent <= 50) {
            // Red to Yellow-ish
            r = 255;
            g = Math.round(220 * (percent / 50));  // max green 220 instead of 255
        } else {
            // Yellow-ish to Darker Green
            g = 180 + Math.round(40 * ((100 - percent) / 50)); // g goes 220->180
            r = Math.round(255 * ((100 - percent) / 50));       // r goes 255->0
        }

        return `rgb(${r},${g},${b})`;
    }

    const downloadTitleText = document.getElementById('test-box-title');
    const downloadResultText = document.getElementById('test-text');
    const downloadTestButton = document.getElementById('download-test-button');
    const downloadTestUnitText = document.getElementById('test-unit-text');
    const downloadTestAverageText = document.getElementById('test-average-text');
    const downloadProgress = document.getElementById('downloadProgress');
    const downloadProgressBar = document.getElementById('downloadSVG');   
    const scaleButton = document.getElementById('scale-button');

    let downloadIsTesting = false; // Global Variable

    const radius = 67.5;
    const fullArc = 2 * Math.PI * radius * 0.75;

function getGradientColor(percent) {
    let r, g, b = 0;
    if (percent <= 50) {
        r = 255;
        g = Math.round(220 * (percent / 50));
    } else {
        g = 180 + Math.round(40 * ((100 - percent) / 50));
        r = Math.round(255 * ((100 - percent) / 50));
    }
    return `rgb(${r},${g},${b})`;
}

function speedToPercent(currentSpeed, topSpeed) {
    if (currentSpeed >= topSpeed) {
        return 100;
    } else if (currentSpeed <= 0) {
        return 0;
    } else {
        return ((currentSpeed / topSpeed) * 100);
    }
}

async function testDownloadSpeed(url, onProgress) {
    const startTime = performance.now();
    let loadedBytes = 0;

    const response = await fetch(url);
    const reader = response.body.getReader();

    const contentLength = response.headers.get("Content-Length");
    const totalBytes = contentLength ? parseInt(contentLength) : 0;

    while (true) {
        if (!downloadIsTesting) break; // allow cancel

        const { done, value } = await reader.read();
        if (done) break;

        loadedBytes += value.length;
        const elapsed = (performance.now() - startTime) / 1000; // seconds
        const speedMbps = (loadedBytes * 8) / (elapsed * 1000 * 1000);
        const percent = totalBytes ? (loadedBytes / totalBytes) * 100 : 0;

        onProgress({ speedMbps, percent });
    }

    const totalElapsed = (performance.now() - startTime) / 1000;
    const averageMbps = (loadedBytes * 8) / (totalElapsed * 1000 * 1000);
    return averageMbps;
}

downloadTestButton.addEventListener('click', async () => {
    if (downloadIsTesting) {
        // cancel
        downloadIsTesting = false;
        downloadTestButton.textContent = "Test Download";
        return;
    }

    downloadIsTesting = true;
    downloadTestButton.textContent = "Cancel";
    downloadTestUnitText.style.display = "inline";
    downloadTestUnitText.textContent = "Mbps";
    downloadTestAverageText.textContent = "";
    downloadResultText.textContent = "0";
    downloadTestButton.style.background = "#FF4444";

    downloadProgress.style.strokeDasharray = "0 424"; // reset progress

    const speeds = [];

    try {
        const avg = await testDownloadSpeed(fileSize_100MB, ({ speedMbps, percent }) => {
            downloadResultText.textContent = speedMbps.toFixed(0);
            downloadProgress.style.stroke = getGradientColor(speedToPercent(speedMbps, topSpeed));
            speeds.push(speedMbps);
            
            const radius = 67.5;
            const fullArc = 2 * Math.PI * radius * 0.75;
            const remaining = 2 * Math.PI * radius - fullArc * (speedToPercent(speedMbps, topSpeed) / 100);
            downloadProgress.style.strokeDasharray = `${fullArc * (speedToPercent(speedMbps, topSpeed) / 100)} ${remaining}`;
            downloadResultText.style.fill = getGradientColor(speedToPercent(speedMbps, topSpeed));
            speed = speedMbps;
        });

        // Put the average up when the test is done
        const numSpeeds = speeds.length;
        const speedsSum = speeds.reduce((accumulator, current) => accumulator + current, 0);
        averageSpeed = speedsSum / numSpeeds;

        downloadTestAverageText.textContent = "average";
        downloadResultText.textContent = averageSpeed.toFixed(0);
        downloadProgress.style.stroke = getGradientColor(speedToPercent(averageSpeed, topSpeed));
        downloadResultText.style.fill = getGradientColor(speedToPercent(averageSpeed, topSpeed));

        // Reset the button
        downloadTestButton.textContent = "Test Download";
        downloadTestButton.style.background = "#45a049";

        // Cancel button logic
        if (downloadIsTesting) {

        } else {
            // If the cancel button is pressed
            
        }

    } catch (err) {
        console.error("Download test failed:", err);
        downloadResultText.textContent = "Error";
    }

    downloadIsTesting = false;
    downloadTestButton.textContent = "Test Download";

    });


    document.addEventListener("DOMContentLoaded", () => {
        const maxLabel = document.getElementById('max-label');
        maxLabel.textContent = topSpeed;
    });


    scaleButton.addEventListener('click', async () => {
        if (topSpeed === 100) {
            topSpeed = 250;
        } else if (topSpeed === 250) {
            topSpeed = 500;
        } else if (topSpeed === 500) {
            topSpeed = 1000;
        } else {
            topSpeed = 100;
        }
        
        const remaining = 2 * Math.PI * radius - fullArc * (speedToPercent(averageSpeed, topSpeed) / 100);
        document.getElementById('downloadProgress').style.strokeDasharray = `${fullArc * (speedToPercent(averageSpeed, topSpeed) / 100)} ${remaining}`;
        document.getElementById('max-label').textContent = topSpeed;
        document.getElementById('downloadProgress').style.stroke = getGradientColor(speedToPercent(averageSpeed, topSpeed));
        document.getElementById('test-text').style.fill = getGradientColor(speedToPercent(averageSpeed, topSpeed));

        if (speed === 0 && averageSpeed === 0) {
            document.getElementById('downloadProgress').style.stroke = "#4CAF50";
        }
        
    });

</script>
</html>