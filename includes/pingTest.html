<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sonnaz Group | Speedtest</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="body-container">
        <h2 id="ping-box-title">Speed Test</h2>
        
        <svg width="300" height="300" viewBox="0 0 200 200">
            <circle class="background" cx="100" cy="100" r="67.5"/>
            <circle class="progress" cx="100" cy="100" r="67.5"/>
            <text x="100" y="100" id="ping-text"></text>
            <text x="100" y="125" id="ping-ms-text">ms</text>
        </svg>

        <button id="ping-test-button">Test Ping</button>
    </div>
</body>
<script>
    // Supported Website
    const host = 'https://api.github.com'; 

    function getGradientColor(percent) {
        let r, g, b = 0;

        if (percent <= 50) {
            // Red to Yellow-ish
            r = 255;
            g = Math.round(220 * (percent / 50));  // max green 220 instead of 255
        } else {
            // Yellow-ish to Darker Green
            g = 180 + Math.round(40 * ((100 - percent) / 50)); // g goes 220->180
            r = Math.round(255 * ((100 - percent) / 50));       // r goes 255->0
        }

        return `rgb(${r},${g},${b})`;
    }

    async function pingHost(host, count = 1) {
        let total = 0;
        for (let i = 0; i < count; i++) {
            const start = performance.now();
            await fetch(host, { method: 'HEAD', cache: 'no-cache' });
            const end = performance.now();
            const time = end - start;
            // console.log(`Ping ${i + 1}: ${time.toFixed(2)} ms`);
            total += time;
        }
        const avg = total / count;
        return avg;
    }


    const pingText = document.getElementById('ping-text');
    const pingButton = document.getElementById('ping-test-button');
    const pingUnitText = document.getElementById('ping-ms-text');
    const progress = document.querySelector('.progress');

    let isTesting = false; // Global Variable

    pingButton.addEventListener('click', async () => {

        // If already running → cancel
        if (isTesting) {
            isTesting = false;
            pingButton.textContent = "Test Ping"; 
            pingButton.style.background = "#4CAF50";
            return;
        }

        // Otherwise start the test
        isTesting = true;
        pingButton.textContent = "Cancel";
        pingButton.style.background = "#FF4444";
        pingUnitText.textContent = "ms";

        // Timing Variables
        const pingTimes = [];
        const pingInterval = 100; // ms (0.1 seconds)
        const pingDuration = 7500; // ms (7.5 seconds)
        const startTime = performance.now(); // Start time

        // Timing Circle Variables
        const radius = 67.5;
        const fullArc = 2 * Math.PI * radius * 0.75; // 270° span
        const fullCircle = 2 * Math.PI * radius // 360° span 

        // Timer
        while (performance.now() - startTime < pingDuration) {

            // Set new progress on the "speedometer"
            const percent = (performance.now() - startTime) / pingDuration
            const startNumber = fullArc * percent
            const endNumber = fullCircle - startNumber
            progress.style.strokeDasharray = `${startNumber} ${endNumber}`;

            // Turn on the 'ms' label below the ping number
            pingUnitText.style.display = "inline";
        
            // Test ping and display result
            try {
                const pingTime = await pingHost(host);
                pingTimes.push(pingTime);

                pingText.textContent = `${pingTime.toFixed(0)}`;
                pingText.style.fill = getGradientColor(100 - pingTime + 15)
                progress.style.stroke = getGradientColor(100 - pingTime + 15)
            } catch (err) {
                console.error('Ping failed:', err);
            }
            await new Promise(resolve => setTimeout(resolve, pingInterval));

            // If it was cancelled, just stop here
            if (!isTesting) {
                progress.style.strokeDasharray = "0 424";
                progress.style.stroke = "#4CAF50";
                pingText.textContent = "";
                pingUnitText.textContent = "";
                return;
            };

        }

        // Otherwise finish normally
        isTesting = false;
        progress.style.strokeDasharray = "318 106";
        pingButton.textContent = "Test Ping";
        pingButton.style.background = "#4CAF50";

        // Set label to average
        const pingAverage = pingTimes.reduce((a,b) => a+b, 0) / pingTimes.length;
        pingText.textContent = `${pingAverage.toFixed(0)}`;
        pingText.style.color = getGradientColor(100 - pingAverage + 15)
    });

    

</script>
</html>